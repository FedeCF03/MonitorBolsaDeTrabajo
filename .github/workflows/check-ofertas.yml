name: Monitor Bolsa UNLP

on:
  schedule:
    - cron: '0 9 * * *'  # 9 AM UTC diario
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: â¬‡ï¸ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ðŸ—ï¸ Setup .NET 10
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '10.0'
    
    - name: ðŸ“¦ Restaurar dependencias
      run: dotnet restore
    
    - name: ðŸ› ï¸ Compilar
      run: dotnet build --configuration Release --no-restore
    
    - name: âš™ï¸ Crear appsettings.json en la raÃ­z
      run: |
        # Crear el archivo en la raÃ­z del proyecto
        cat > appsettings.json << 'EOF'
        {
          "EmailSettings": {
            "SmtpServer": "${{ secrets.SMTP_SERVER }}",
            "SmtpPort": ${{ secrets.SMTP_PORT }},
            "SenderEmail": "${{ secrets.SENDER_EMAIL }}",
            "SenderPassword": "${{ secrets.SENDER_PASSWORD }}",
            "RecipientEmail": "${{ secrets.RECIPIENT_EMAIL }}",
            "SenderName": "Monitor Bolsa UNLP"
          },
          "ScrapingSettings": {
            "BaseUrl": "https://bolsa.info.unlp.edu.ar/ver_ofertas",
            "StorageFilePath": "ofertas.json"
          }
        }
        EOF
        
        echo "âœ… appsettings.json creado en: $(pwd)/appsettings.json"
        echo "ðŸ“„ Contenido (sin password):"
        cat appsettings.json | sed 's/".*Password.*": ".*",/"SenderPassword": "***",/'
    
    - name: ðŸ“ Listar archivos (debug)
      run: |
        echo "ðŸ“ Directorio actual: $(pwd)"
        echo "ðŸ“ Archivos en raÃ­z:"
        ls -la
        
        echo "ðŸ“ Archivos en bin/Release:"
        ls -la bin/Release/ || echo "No existe bin/Release"
        
        echo "ðŸ“„ Verificar appsettings.json:"
        if [ -f "appsettings.json" ]; then
          echo "âœ… appsettings.json existe"
          echo "Ruta absoluta: $(realpath appsettings.json)"
        else
          echo "âŒ appsettings.json NO existe"
        fi
    
    - name: ðŸ” Ejecutar monitor
      run: |
        echo "ðŸ• Iniciando ejecuciÃ³n..."
        # IMPORTANTE: Ejecutar DESDE LA RAÃZ del proyecto
        dotnet run --configuration Release --no-build -- --run-once
        echo "âœ… Finalizado"
    
    - name: ðŸ’¾ Guardar cambios
      if: success()
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        if git diff --quiet ofertas.json; then
          echo "ðŸ“„ No hay cambios en ofertas.json"
        else
          echo "ðŸ“„ Cambios detectados - Commit y Push"
          git add ofertas.json
          git commit -m "ðŸ“¢ Actualizar ofertas - $(date +'%Y-%m-%d %H:%M')"
          git push
        fi