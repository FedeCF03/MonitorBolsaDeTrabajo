name: Monitor Bolsa UNLP

on:
  schedule:
    - cron: '0 9 * * *'  # 9 AM UTC = 6 AM Argentina
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: â¬‡ï¸ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ—ï¸ Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.x'
    
    - name: ğŸ“¦ Compilar proyecto
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore
    
    - name: âš™ï¸ Crear appsettings.json SIMPLE
      run: |
        # MÃ©todo SIMPLE - crear lÃ­nea por lÃ­nea
        echo '{' > appsettings.json
        echo '  "EmailSettings": {' >> appsettings.json
        echo '    "SmtpServer": "smtp.gmail.com",' >> appsettings.json
        echo '    "SmtpPort": 587,' >> appsettings.json
        echo '    "SenderEmail": "'"${{ secrets.SENDER_EMAIL }}"'",' >> appsettings.json
        echo '    "SenderPassword": "'"${{ secrets.SENDER_PASSWORD }}"'",' >> appsettings.json
        echo '    "RecipientEmail": "'"${{ secrets.RECIPIENT_EMAIL }}"'",' >> appsettings.json
        echo '    "SenderName": "Monitor Bolsa UNLP"' >> appsettings.json
        echo '  },' >> appsettings.json
        echo '  "ScrapingSettings": {' >> appsettings.json
        echo '    "BaseUrl": "https://bolsa.info.unlp.edu.ar/ver_ofertas",' >> appsettings.json
        echo '    "StorageFilePath": "ofertas.json"' >> appsettings.json
        echo '  }' >> appsettings.json
        echo '}' >> appsettings.json
        
        echo "âœ… appsettings.json creado exitosamente"
        echo "ğŸ“„ Contenido (seguro):"
        # Mostrar sin password
        sed 's/"SenderPassword": ".*"/"SenderPassword": "***"/' appsettings.json
    
    - name: ğŸ” Verificar JSON
      run: |
        echo "ğŸ” Validando JSON..."
        if python3 -c "import json; json.load(open('appsettings.json')); print('âœ… JSON vÃ¡lido')"; then
          echo "âœ… JSON es vÃ¡lido"
        else
          echo "âŒ JSON invÃ¡lido"
          echo "ğŸ“„ Contenido crudo:"
          cat -A appsettings.json
          exit 1
        fi
    
    - name: ğŸš€ Ejecutar monitor
      run: |
        echo "ğŸ• Iniciando ejecuciÃ³n..."
        dotnet run --configuration Release --no-build -- --run-once
        echo "ğŸ‰ Proceso completado"
    
    - name: ğŸ’¾ Guardar ofertas actualizadas
      if: success()
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        if git diff --quiet ofertas.json; then
          echo "ğŸ“„ No hay cambios en ofertas.json"
        else
          echo "ğŸ“„ Guardando cambios..."
          git add ofertas.json
          git commit -m "ğŸ“¢ Actualizar ofertas - $(date +'%Y-%m-%d %H:%M')"
          git push
        fi