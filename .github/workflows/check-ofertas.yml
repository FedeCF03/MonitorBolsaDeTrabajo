name: Monitor Bolsa UNLP

on:
  schedule:
    - cron: '0 9 * * *'  # 9 AM UTC = 6 AM Argentina
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '10.x'
    
    - name: Verificar Secrets
      run: |
        echo "ðŸ” DEBUG - Mostrando variables:"
        echo "SMTP_SERVER: ${{ secrets.SMTP_SERVER }}"
        echo "SMTP_PORT: '${{ secrets.SMTP_PORT }}'"
        echo "SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}"
        echo "RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}"
        echo "ðŸ”¢ El puerto es nÃºmero? (deberÃ­a ser 587):"
        if [[ "${{ secrets.SMTP_PORT }}" =~ ^[0-9]+$ ]]; then
          echo "âœ… SMTP_PORT es un nÃºmero vÃ¡lido: ${{ secrets.SMTP_PORT }}"
        else
          echo "âŒ ERROR: SMTP_PORT no es un nÃºmero: '${{ secrets.SMTP_PORT }}'"
          echo "ðŸ’¡ Ve a Settings â†’ Secrets y cambia SMTP_PORT a '587'"
          exit 1
        fi
    
    - name: Compilar
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore
    
    - name: Crear appsettings.json CON VALORES DIRECTOS
      run: |
        # Instalar jq si no estÃ¡ disponible
        if ! command -v jq &> /dev/null; then
          sudo apt-get update && sudo apt-get install -y jq
        fi

        # Crear el archivo JSON usando jq para manejar valores correctamente
        jq -n \
          --arg sender_email "${{ secrets.SENDER_EMAIL }}" \
          --arg sender_password "${{ secrets.SENDER_PASSWORD }}" \
          --arg recipient_email "${{ secrets.RECIPIENT_EMAIL }}" \
          '{
            EmailSettings: {
              SmtpServer: "smtp.gmail.com",
              SmtpPort: "587",
              SenderEmail: $sender_email,
              SenderPassword: $sender_password,
              RecipientEmail: $recipient_email,
              SenderName: "Monitor Bolsa UNLP"
            },
            ScrapingSettings: {
              BaseUrl: "https://bolsa.info.unlp.edu.ar/ver_ofertas",
              StorageFilePath: "ofertas.json"
            }
          }' > appsettings.json

        echo "âœ… appsettings.json creado"
        echo "ðŸ“„ Contenido:"
        cat appsettings.json | sed 's/".*Password.*": ".*",/"SenderPassword": "***",/'
    
    - name: Ejecutar monitor
      run: |
        echo "ðŸš€ Iniciando ejecuciÃ³n..."
        dotnet run --configuration Release --no-build -- --run-once
        echo "ðŸŽ‰ Proceso completado"
    
    - name: Guardar cambios
      if: success()
      run: |
        git config --local user.email "github-actions@users.noreply.github.com"
        git config --local user.name "GitHub Actions"
        
        if [ -f "ofertas.json" ] && git diff --quiet ofertas.json; then
          echo "ðŸ“„ Sin cambios en ofertas.json"
        else
          echo "ðŸ“„ Guardando cambios..."
          git add ofertas.json
          git commit -m "ðŸ“¢ Actualizar ofertas - $(date +'%Y-%m-%d %H:%M UTC')"
          git push
        fi